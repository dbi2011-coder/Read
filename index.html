<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù‚Ø±Ø£Ø© Ø§Ù„ØªÙ„Ø§ÙˆØ©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none !important; }
        
        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¢ÙŠØ§Øª Ù„Ù„Ù‚Ø§Ø±Ø¦Ø© */
        .verses-box {
            background: #e8f5e9; /* Ø®Ù„ÙÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§Ù‹ */
            padding: 20px;
            border-radius: 15px;
            border-right: 5px solid #2e7d32; /* Ø®Ø· Ø¬Ø§Ù†Ø¨ÙŠ Ø¬Ù…Ø§Ù„ÙŠ */
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .verses-box h3 {
            color: #1b5e20;
            margin-top: 0;
            font-size: 16px;
        }

        #assignedVerses {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        #surahInfo {
            color: #555;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <div class="container" id="bookingScreen">
        <h1>Ø­Ø¬Ø² Ø¯ÙˆØ± Ù„Ù„ØªÙ„Ø§ÙˆØ© ğŸ“–</h1>
        <p style="color: #666; margin-bottom: 20px;">Ø³Ø¬Ù„ÙŠ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø·Ø§Ø¨ÙˆØ±</p>
        
        <input type="text" id="readerName" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
        <button class="big-circle-btn" onclick="handleBook()">Ø­Ø¬Ø² Ø¯ÙˆØ±</button>
        <p id="errorMsg" style="color: red;"></p>
    </div>

    <div class="container hidden" id="statusScreen">
        <h2 id="welcomeName" style="color: #00796b;">...</h2>
        
        <div class="verses-box">
            <h3>ğŸ“– Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ:</h3>
            <p id="surahInfo">...</p>
            <p id="assignedVerses">...</p>
        </div>

        <div id="roleBox" class="status-box waiting">
            <h1 id="statusText">...</h1>
            <p id="subStatus">...</p>
        </div>
        
        <button onclick="location.reload()" style="background:none; color:#999; border:none; margin-top:20px; font-size:12px; box-shadow:none;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <script>
        const STORAGE_KEY = 'quran_queue_offline_v3';
        let myId = null;

        const surahNames = [
            "", "Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", 
            "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", 
            "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", 
            "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", 
            "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", 
            "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", 
            "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", 
            "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", 
            "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", 
            "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", 
            "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", 
            "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"
        ];

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function getState() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { settings: {}, queue: [], currentReaderIndex: -1, isBookingStopped: false };
        }

        function saveState(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function calculateVersesBlock(startFrom, amountType, amountValue) {
            let start = parseInt(startFrom); 
            let end = start;
            if (amountType === 'verses') end = start + parseInt(amountValue) - 1;
            else if (amountType === 'quarter') end = start + 7; 
            else if (amountType === 'half') end = start + 14; 
            else if (amountType === 'full') end = start + 28; 
            return { start, end, text: `Ù…Ù† Ø¢ÙŠØ© ${start} Ø¥Ù„Ù‰ ${end}` };
        }

        function recalculateQueueVerses(state) {
            if (!state.queue) state.queue = [];
            let nextStartVerse = state.settings.startVerse;
            if (state.currentReaderIndex >= 0 && state.queue[state.currentReaderIndex]) {
                nextStartVerse = state.queue[state.currentReaderIndex].endV + 1;
            } 
            for (let i = state.currentReaderIndex + 1; i < state.queue.length; i++) {
                const info = calculateVersesBlock(nextStartVerse, state.settings.amountType, state.settings.amountValue);
                state.queue[i].startV = info.start;
                state.queue[i].endV = info.end;
                state.queue[i].verses = info.text;
                nextStartVerse = info.end + 1;
            }
            return state;
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² ---
        function handleBook() {
            const nameInput = document.getElementById('readerName');
            const name = nameInput.value.trim();
            const errorMsg = document.getElementById('errorMsg');

            if (!name) {
                errorMsg.innerText = "Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…";
                return;
            }

            let state = getState();

            if (state.isBookingStopped) {
                errorMsg.innerText = "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ø§Ù„Ø­Ø¬Ø² Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯.";
                return;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø±Ø¦Ø©
            const newReader = {
                id: Date.now(), 
                name: name,
                verses: "...", 
                surah: surahNames[state.settings.surah] || "Ø³ÙˆØ±Ø© Ù…Ø®ØªØ§Ø±Ø©",
                startV: 0,
                endV: 0
            };

            if (!state.queue) state.queue = [];
            state.queue.push(newReader);
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢ÙŠØ§Øª
            state = recalculateQueueVerses(state);
            saveState(state);

            // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­Ø¬Ø²
            myId = newReader.id;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø§Ù„Ø©
            document.getElementById('bookingScreen').classList.add('hidden');
            document.getElementById('statusScreen').classList.remove('hidden');
            document.getElementById('welcomeName').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ: ${newReader.name}`;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹
            updateUserUI(state);
        }

        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        function updateUserUI(state) {
            if (!myId) return; 

            const myReader = state.queue ? state.queue.find(r => r.id === myId) : null;
            const myIndex = state.queue ? state.queue.findIndex(r => r.id === myId) : -1;
            const currentIndex = state.currentReaderIndex;

            // 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø±Ø¯/Ø§Ù„Ø­Ø°Ù
            if (!myReader) {
                if (!document.getElementById('statusScreen').classList.contains('hidden')) {
                    alert("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø².");
                    location.reload();
                }
                return;
            }

            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢ÙŠØ§Øª (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ§Øª)
            // Ù†Ø£Ø®Ø° Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const sName = surahNames[state.settings.surah] || "Ø³ÙˆØ±Ø©";
            document.getElementById('surahInfo').innerText = `Ø³ÙˆØ±Ø© ${sName}`;
            document.getElementById('assignedVerses').innerText = myReader.verses;

            // 3. Ù‡Ù„ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¯ÙˆØ±ØŸ
            if (myIndex < currentIndex && myIndex !== -1) {
                alert("Ø§Ù†ØªÙ‡Ù‰ Ø¯ÙˆØ±ÙƒØŒ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ùƒ!");
                location.reload();
                return;
            }

            // 4. Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ± (Ø£Ù„ÙˆØ§Ù†)
            const roleBox = document.getElementById('roleBox');
            const statusText = document.getElementById('statusText');
            const subStatus = document.getElementById('subStatus');
            const peopleBeforeMe = myIndex - currentIndex;

            roleBox.classList.remove('waiting', 'ready', 'active');

            if (peopleBeforeMe === 0) {
                roleBox.classList.add('active');
                statusText.innerText = "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ğŸ¤";
                subStatus.innerText = "ØªÙØ¶Ù„ÙŠ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©";
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            } else if (peopleBeforeMe === 1) {
                roleBox.classList.add('ready');
                statusText.innerText = "Ø§Ø³ØªØ¹Ø¯ÙŠ..";
                subStatus.innerText = "Ø£Ù†ØªÙ Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
            } else {
                roleBox.classList.add('waiting');
                statusText.innerText = "Ø§Ù†ØªØ¸Ø§Ø±";
                subStatus.innerText = `ÙŠØ³Ø¨Ù‚Ùƒ ${peopleBeforeMe} Ù‚Ø§Ø±Ø¦Ø§Øª`;
            }
        }

        // --- Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ---
        window.onload = function() {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¢Ø®Ø±
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    updateUserUI(JSON.parse(e.newValue));
                }
            });
        };
    </script>
</body>
</html>
