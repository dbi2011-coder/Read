<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù‚Ø±Ø£Ø© Ø§Ù„ØªÙ„Ø§ÙˆØ©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none !important; }
        
        .verses-box {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 15px;
            border-right: 5px solid #2e7d32;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .verses-box h3 {
            color: #1b5e20;
            margin-top: 0;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #assignedVerses {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
            display: block;
        }

        #surahInfo {
            color: #00796b;
            font-size: 20px;
            font-weight: bold;
            display: block;
        }
    </style>
</head>
<body>

    <div class="container" id="bookingScreen">
        <h1>Ø­Ø¬Ø² Ø¯ÙˆØ± Ù„Ù„ØªÙ„Ø§ÙˆØ© ğŸ“–</h1>
        <p style="color: #666; margin-bottom: 20px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†</p>
        
        <input type="text" id="readerName" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button class="big-circle-btn" onclick="handleBook()">Ø­Ø¬Ø² Ø¯ÙˆØ±</button>
        <p id="errorMsg" style="color: red;"></p>
    </div>

    <div class="container hidden" id="statusScreen">
        <h2 id="welcomeName" style="color: #00796b;">...</h2>
        
        <div class="verses-box">
            <h3>ğŸ“– Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ:</h3>
            <div id="surahInfo">...</div>
            <div id="assignedVerses">...</div>
        </div>

        <div id="roleBox" class="status-box waiting">
            <h1 id="statusText">...</h1>
            <p id="subStatus">...</p>
        </div>
        
        <button onclick="location.reload()" style="background:none; color:#999; border:none; margin-top:20px; font-size:12px; box-shadow:none;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <script>
        const STORAGE_KEY = 'quran_queue_offline_v3';
        let myId = null;

        const surahNames = [
            "", "Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", 
            "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", 
            "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", 
            "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", 
            "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", 
            "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", 
            "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", 
            "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", 
            "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", 
            "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", 
            "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", 
            "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"
        ];

        function getState() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { settings: {surah: 1}, queue: [], currentReaderIndex: -1, isBookingStopped: false };
        }

        function saveState(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function calculateVersesBlock(startFrom, amountType, amountValue) {
            let start = parseInt(startFrom); 
            let end = start;
            if (amountType === 'verses') end = start + parseInt(amountValue) - 1;
            else if (amountType === 'quarter') end = start + 7; 
            else if (amountType === 'half') end = start + 14; 
            else if (amountType === 'full') end = start + 28; 
            return { start, end, text: `Ù…Ù† Ø¢ÙŠØ© ${start} Ø¥Ù„Ù‰ ${end}` };
        }

        function recalculateQueueVerses(state) {
            if (!state.queue) state.queue = [];
            if(!state.settings) state.settings = { surah: 1, startVerse: 1, amountType: 'verses', amountValue: 5 };

            let nextStartVerse = state.settings.startVerse;
            if (state.currentReaderIndex >= 0 && state.queue[state.currentReaderIndex]) {
                nextStartVerse = state.queue[state.currentReaderIndex].endV + 1;
            } 
            
            for (let i = state.currentReaderIndex + 1; i < state.queue.length; i++) {
                const info = calculateVersesBlock(nextStartVerse, state.settings.amountType, state.settings.amountValue);
                state.queue[i].startV = info.start;
                state.queue[i].endV = info.end;
                state.queue[i].verses = info.text;
                nextStartVerse = info.end + 1;
            }
            return state;
        }

        function handleBook() {
            let state = getState();
            const errorMsg = document.getElementById('errorMsg');

            if (state.isBookingStopped) {
                errorMsg.innerText = "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ø§Ù„Ø­Ø¬Ø² Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯.";
                return;
            }

            const nameInput = document.getElementById('readerName');
            let name = nameInput.value.trim();
            if (!name) {
                const nextNum = (state.queue ? state.queue.length : 0) + 1;
                name = `Ù‚Ø§Ø±Ø¦Ø© ${nextNum}`;
            }

            if (!state.queue) state.queue = [];
            
            const newReader = {
                id: Date.now(), 
                name: name,
                verses: "...", 
                surah: "", 
                startV: 0,
                endV: 0
            };

            state.queue.push(newReader);
            state = recalculateQueueVerses(state);
            saveState(state);

            myId = newReader.id;
            
            document.getElementById('bookingScreen').classList.add('hidden');
            document.getElementById('statusScreen').classList.remove('hidden');
            document.getElementById('welcomeName').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ: ${name}`;
            
            updateUserUI(state);
        }

        function updateUserUI(state) {
            if (!myId) return; 

            const myReader = state.queue ? state.queue.find(r => r.id === myId) : null;
            const myIndex = state.queue ? state.queue.findIndex(r => r.id === myId) : -1;
            const currentIndex = state.currentReaderIndex; // ÙŠØ¨Ø¯Ø£ Ù…Ù† -1

            if (!myReader) {
                if (!document.getElementById('statusScreen').classList.contains('hidden')) {
                    alert("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø².");
                    location.reload();
                }
                return;
            }

            let surahNameText = "Ø³ÙˆØ±Ø© Ù…Ø®ØªØ§Ø±Ø©";
            if (state.settings && state.settings.surah) {
                surahNameText = `Ø³ÙˆØ±Ø© ${surahNames[state.settings.surah]}`;
            }
            document.getElementById('surahInfo').innerText = surahNameText;
            document.getElementById('assignedVerses').innerText = myReader.verses;

            if (myIndex < currentIndex && myIndex !== -1) {
                alert("Ø§Ù†ØªÙ‡Ù‰ Ø¯ÙˆØ±ÙƒØŒ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ùƒ!");
                location.reload();
                return;
            }

            // --- ğŸ”¥ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ğŸ”¥ ---
            const roleBox = document.getElementById('roleBox');
            const statusText = document.getElementById('statusText');
            const subStatus = document.getElementById('subStatus');
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø¯ÙˆØ±ÙŠ ÙˆØ¯ÙˆØ± Ø§Ù„Ù…Ø´Ø±ÙØ©
            const diff = myIndex - currentIndex;

            roleBox.classList.remove('waiting', 'ready', 'active');

            if (diff === 0) {
                // Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¢Ù† (Ø§Ù„Ù…Ø´Ø±ÙØ© ØªÙ‚Ù Ø¹Ù†Ø¯ÙŠ)
                roleBox.classList.add('active');
                statusText.innerText = "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ğŸ¤";
                subStatus.innerText = "ØªÙØ¶Ù„ÙŠ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©";
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            
            } else if (diff === 1) {
                // Ø£Ù†Ø§ Ø§Ù„ØªØ§Ù„ÙŠØ©
                roleBox.classList.add('ready');
                
                // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´Ø±ÙØ© Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ (currentIndex = -1) ÙˆØ£Ù†Ø§ Ø±Ù‚Ù… 0
                // Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´Ø±ÙØ© ØªÙ‚Ù Ø¹Ù†Ø¯ Ø´Ø®Øµ ÙˆØ£Ù†Ø§ Ø¨Ø¹Ø¯Ù‡
                
                if (currentIndex === -1) {
                    // Ø£Ù†Ø§ Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙˆØ§Ù„Ù…Ø´Ø±ÙØ© Ù„Ù… ØªØ¶ØºØ· Ø¨Ø¯Ø¡
                    statusText.innerText = "Ø£Ù†ØªÙ Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰";
                    subStatus.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø±ÙØ© Ù„Ù„Ø¬Ù„Ø³Ø©...";
                } else {
                    // Ù‡Ù†Ø§Ùƒ Ø´Ø®Øµ ÙŠÙ‚Ø±Ø£ ÙˆØ£Ù†Ø§ Ø¨Ø¹Ø¯Ù‡
                    statusText.innerText = "Ø§Ø³ØªØ¹Ø¯ÙŠ..";
                    subStatus.innerText = "Ø£Ù†ØªÙ Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
                }
                
            } else {
                // Ø§Ù†ØªØ¸Ø§Ø± (ÙŠÙˆØ¬Ø¯ Ù†Ø§Ø³ Ù‚Ø¨Ù„ÙŠ)
                roleBox.classList.add('waiting');
                statusText.innerText = "Ø§Ù†ØªØ¸Ø§Ø±";
                
                // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† Ø£Ù…Ø§Ù…ÙŠ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ø­ØªØ³Ø§Ø¨ Ù…Ù† ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø¢Ù†)
                // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (ØªØ±ØªÙŠØ¨ÙŠ) - (ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„ÙŠ ÙŠÙ‚Ø±Ø£) - 1
                const waitingAhead = diff - 1;
                
                subStatus.innerText = `ÙŠØ³Ø¨Ù‚Ùƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ${waitingAhead} Ù‚Ø§Ø±Ø¦Ø§Øª`;
            }
        }

        window.onload = function() {
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    updateUserUI(JSON.parse(e.newValue));
                }
            });
        };
    </script>
</body>
</html>
