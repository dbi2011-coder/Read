<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø£Ø© (Ø§Ù„Ù…Ø´Ø±ÙØ©)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Ø¥ØµÙ„Ø§Ø­ Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ø®ÙÙŠØ© */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container" id="loginScreen">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±ÙØ©</h2>
        <input type="password" id="adminPass" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (1234)">
        <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div class="container hidden" id="setupScreen">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
        
        <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©:</label>
        <select id="surahNum"></select>
        
        <label>Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø¢ÙŠØ©:</label>
        <input type="number" id="startVerse" value="1">
        
        <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©:</label>
        <select id="amountType" onchange="toggleAmountInput()">
            <option value="verses">Ø¹Ø¯Ø¯ Ø¢ÙŠØ§Øª Ù…Ø­Ø¯Ø¯</option>
            <option value="quarter">Ø±Ø¨Ø¹ ÙˆØ¬Ù‡</option>
            <option value="half">Ù†ØµÙ ÙˆØ¬Ù‡</option>
            <option value="full">ÙˆØ¬Ù‡ ÙƒØ§Ù…Ù„</option>
        </select>
        
        <input type="number" id="amountValue" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª">
        
        <button onclick="handleStartSession()">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>

    <div class="container hidden" id="dashboardScreen">
        <div style="display: flex; justify-content: space-between;">
            <span id="waitingCount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 0</span>
            <button class="btn-danger" id="stopBookingBtn" onclick="handleToggleBooking()">ØªØ­Ù…ÙŠÙ„...</button>
        </div>

        <button class="big-circle-btn" onclick="handleNextReader()">Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â©</button>
        
        <div id="currentReaderDisplay" style="margin: 20px 0; font-weight: bold; color: #00796b;">
            ...
        </div>

        <button class="btn-secondary" onclick="toggleTable()">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦Ø§Øª ğŸ“‹</button>
        
        <div id="readersTableContainer" class="hidden">
            <table id="readersTable">
                <thead>
                    <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø¢ÙŠØ§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª ---
        const STORAGE_KEY = 'quran_queue_offline_v3';
        const surahNames = [
            "", "Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", 
            "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", 
            "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", 
            "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", 
            "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", 
            "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", 
            "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", 
            "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", 
            "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", 
            "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", 
            "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", 
            "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"
        ];

        // --- 2. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        function getState() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : {
                settings: { surah: 1, startVerse: 1, amountType: 'verses', amountValue: 5 },
                queue: [],
                currentReaderIndex: -1,
                isBookingStopped: false
            };
        }

        function saveState(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            updateDashboardUI(state); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø´Ø§Ø´Ø©
        }

        function calculateVersesBlock(startFrom, amountType, amountValue) {
            let start = parseInt(startFrom); 
            let end = start;
            if (amountType === 'verses') end = start + parseInt(amountValue) - 1;
            else if (amountType === 'quarter') end = start + 7; 
            else if (amountType === 'half') end = start + 14; 
            else if (amountType === 'full') end = start + 28; 
            return { start, end, text: `Ù…Ù† Ø¢ÙŠØ© ${start} Ø¥Ù„Ù‰ ${end}` };
        }

        function recalculateQueueVerses(state) {
            if (!state.queue) state.queue = [];
            let nextStartVerse = state.settings.startVerse;
            if (state.currentReaderIndex >= 0 && state.queue[state.currentReaderIndex]) {
                nextStartVerse = state.queue[state.currentReaderIndex].endV + 1;
            } 
            for (let i = state.currentReaderIndex + 1; i < state.queue.length; i++) {
                const info = calculateVersesBlock(nextStartVerse, state.settings.amountType, state.settings.amountValue);
                state.queue[i].startV = info.start;
                state.queue[i].endV = info.end;
                state.queue[i].verses = info.text;
                nextStartVerse = info.end + 1;
            }
            return state;
        }

        // --- 3. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø§Ù„Ø£Ø²Ø±Ø§Ø±) ---
        function handleLogin() {
            const pass = document.getElementById('adminPass').value;
            if (pass === "1234") {
                document.getElementById('loginScreen').classList.add('hidden');
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©ØŸ
                const state = getState();
                if (state.queue && state.queue.length > 0) {
                    document.getElementById('dashboardScreen').classList.remove('hidden');
                    updateDashboardUI(state);
                } else {
                    document.getElementById('setupScreen').classList.remove('hidden');
                }
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
            }
        }

        function toggleAmountInput() {
            const val = document.getElementById('amountType').value;
            document.getElementById('amountValue').style.display = (val === 'verses') ? 'block' : 'none';
        }

        function handleStartSession() {
            const surah = document.getElementById('surahNum').value;
            const startV = document.getElementById('startVerse').value;
            const type = document.getElementById('amountType').value;
            const val = document.getElementById('amountValue').value || 5;
            
            const state = {
                settings: { surah, startVerse: parseInt(startV), amountType: type, amountValue: val },
                queue: [],
                currentReaderIndex: -1,
                isBookingStopped: false
            };
            saveState(state);
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
        }

        function handleNextReader() {
            let state = getState();
            if (state.queue.length > state.currentReaderIndex + 1) {
                state.currentReaderIndex++;
                saveState(state);
            } else {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ø§Ø±Ø¦Ø§Øª ØªØ§Ù„ÙŠØ§Øª!");
            }
        }

        function handleToggleBooking() {
            let state = getState();
            state.isBookingStopped = !state.isBookingStopped;
            saveState(state);
        }

        function deleteReader(index) {
            let state = getState();
            state.queue.splice(index, 1);
            if (index < state.currentReaderIndex) state.currentReaderIndex--;
            else state = recalculateQueueVerses(state);
            saveState(state);
        }

        function makeUrgent(index) {
            let state = getState();
            if (index > state.currentReaderIndex + 1) {
                const reader = state.queue.splice(index, 1)[0]; 
                state.queue.splice(state.currentReaderIndex + 1, 0, reader);
                state = recalculateQueueVerses(state);
                saveState(state);
            }
        }

        function toggleTable() {
            document.getElementById('readersTableContainer').classList.toggle('hidden');
        }

        // --- 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© (UI) ---
        function updateDashboardUI(state) {
            if(!state) return;

            // Ø²Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
            const btnStop = document.getElementById('stopBookingBtn');
            btnStop.innerText = state.isBookingStopped ? "ÙØªØ­ Ø§Ù„Ø­Ø¬Ø²" : "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø¬Ø²";
            btnStop.style.backgroundColor = state.isBookingStopped ? "#4CAF50" : "#d32f2f";

            // Ø§Ù„Ø¹Ø¯Ø§Ø¯
            const remaining = (state.queue ? state.queue.length : 0) - (state.currentReaderIndex + 1);
            document.getElementById('waitingCount').innerText = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining > 0 ? remaining : 0}`;

            // Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if (state.queue && state.currentReaderIndex >= 0 && state.currentReaderIndex < state.queue.length) {
                const curr = state.queue[state.currentReaderIndex];
                document.getElementById('currentReaderDisplay').innerText = `ØªÙ‚Ø±Ø£ Ø§Ù„Ø¢Ù†: ${curr.name} (${curr.verses})`;
            } else {
                document.getElementById('currentReaderDisplay').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡...";
            }

            // Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const tbody = document.querySelector('#readersTable tbody');
            tbody.innerHTML = '';
            if(state.queue) {
                state.queue.forEach((reader, index) => {
                    if (index >= state.currentReaderIndex) {
                        const row = `<tr>
                            <td>${reader.name}</td>
                            <td>${index + 1}</td>
                            <td>${reader.verses}</td>
                            <td>
                                ${index > state.currentReaderIndex ? `<button class="btn-danger" style="padding:5px" onclick="deleteReader(${index})">Ø­Ø°Ù</button>` : 'Ø­Ø§Ù„ÙŠØ§Ù‹'}
                                ${index > state.currentReaderIndex + 1 ? `<button style="padding:5px" onclick="makeUrgent(${index})">Ù…Ø³ØªØ¹Ø¬Ù„Ø©</button>` : ''}
                            </td>
                        </tr>`;
                        tbody.innerHTML += row;
                    }
                });
            }
        }

        // --- 5. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ---
        window.onload = function() {
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³ÙˆØ±
            const surahSelect = document.getElementById('surahNum');
            for (let i = 1; i < surahNames.length; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `${i}. ${surahNames[i]}`;
                surahSelect.appendChild(option);
            }
            surahSelect.value = 2; // Ø§Ù„Ø¨Ù‚Ø±Ø©

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦Ø§Øª
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    updateDashboardUI(JSON.parse(e.newValue));
                }
            });
            
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø­Ø§Ù„Ø©
            updateDashboardUI(getState());
        };
    </script>
</body>
</html>
