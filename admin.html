<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù‚Ø±Ø£Ø© Ø§Ù„ØªÙ„Ø§ÙˆØ© - Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…Ø¹Ù„Ù…</title>
    <link rel="stylesheet" href="style.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
    
    <style>
        .hidden { display: none !important; }
        
        /* ØªØµÙ…ÙŠÙ… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…ØµØ­Ù */
        .quran-container {
            background-color: #fffbf2; /* Ù„ÙˆÙ† ÙˆØ±Ù‚ Ø§Ù„Ù…ØµØ­Ù */
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37; /* Ø¥Ø·Ø§Ø± Ø°Ù‡Ø¨ÙŠ */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .quran-text {
            font-family: 'Amiri Quran', serif;
            font-size: 26px;
            line-height: 2.2;
            color: #000;
            direction: rtl;
            margin-bottom: 20px;
        }

        .basmala {
            font-family: 'Amiri Quran', serif;
            font-size: 22px;
            color: #555;
            margin-bottom: 15px;
        }

        .ayah-symbol {
            color: #d4af37;
            font-size: 24px;
            margin: 0 5px;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØª */
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }

        .btn-audio {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-audio:hover { background-color: #555; }
        .playing { background-color: #c62828 !important; }

    </style>
</head>
<body>

    <div class="container" id="bookingScreen">
        <h1>Ø­Ø¬Ø² Ø¯ÙˆØ± Ù„Ù„ØªÙ„Ø§ÙˆØ© ğŸ“–</h1>
        <p style="color: #666; margin-bottom: 20px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¬Ø² Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†</p>
        
        <input type="text" id="readerName" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button class="big-circle-btn" onclick="handleBook()">Ø­Ø¬Ø² Ø¯ÙˆØ±</button>
        <p id="errorMsg" style="color: red;"></p>
    </div>

    <div class="container hidden" id="statusScreen">
        <h2 id="welcomeName" style="color: #00796b;">...</h2>
        
        <div class="quran-container">
            <h3 id="surahTitle" style="color: #d4af37; margin-top:0;">...</h3>
            
            <div id="quranLoading" style="color: #888; font-size: 14px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª...</div>
            
            <div id="quranTextDisplay" class="quran-text"></div>
            
            <div class="audio-controls hidden" id="audioControls">
                <button class="btn-audio" id="playBtn" onclick="toggleAudio()">
                    ğŸ”Š Ø§Ø³ØªÙ…Ø§Ø¹ (Ø§Ù„Ø­ØµØ±ÙŠ)
                </button>
                <div id="audioStatus" style="font-size: 12px; color: #666; align-self: center;"></div>
            </div>
        </div>

        <div id="roleBox" class="status-box waiting">
            <h1 id="statusText">...</h1>
            <p id="subStatus">...</p>
        </div>
        
        <button onclick="location.reload()" style="background:none; color:#999; border:none; margin-top:20px; font-size:12px; box-shadow:none;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        const STORAGE_KEY = 'quran_queue_offline_v3';
        let myId = null;
        let audioPlaylist = []; // Ù‚Ø§Ø¦Ù…Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¢ÙŠØ§Øª
        let currentAudioIndex = 0;
        let isPlaying = false;

        const surahNames = [
            "", "Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³", 
            "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡", 
            "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…", 
            "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±", 
            "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚", 
            "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", 
            "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", 
            "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³", 
            "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯", 
            "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", 
            "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±", 
            "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"
        ];

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        function getState() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { settings: {surah: 1}, queue: [], currentReaderIndex: -1, isBookingStopped: false };
        }

        function saveState(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function calculateVersesBlock(startFrom, amountType, amountValue) {
            let start = parseInt(startFrom); 
            let end = start;
            if (amountType === 'verses') end = start + parseInt(amountValue) - 1;
            else if (amountType === 'quarter') end = start + 7; 
            else if (amountType === 'half') end = start + 14; 
            else if (amountType === 'full') end = start + 28; 
            return { start, end, text: `Ù…Ù† Ø¢ÙŠØ© ${start} Ø¥Ù„Ù‰ ${end}` };
        }

        function recalculateQueueVerses(state) {
            if (!state.queue) state.queue = [];
            if(!state.settings) state.settings = { surah: 1, startVerse: 1, amountType: 'verses', amountValue: 5 };
            let nextStartVerse = state.settings.startVerse;
            if (state.currentReaderIndex >= 0 && state.queue[state.currentReaderIndex]) {
                nextStartVerse = state.queue[state.currentReaderIndex].endV + 1;
            } 
            for (let i = state.currentReaderIndex + 1; i < state.queue.length; i++) {
                const info = calculateVersesBlock(nextStartVerse, state.settings.amountType, state.settings.amountValue);
                state.queue[i].startV = info.start;
                state.queue[i].endV = info.end;
                state.queue[i].verses = info.text;
                nextStartVerse = info.end + 1;
            }
            return state;
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² ---
        function handleBook() {
            let state = getState();
            if (state.isBookingStopped) {
                document.getElementById('errorMsg').innerText = "Ù†Ø¹ØªØ°Ø± Ù…Ù†ÙƒØŒ Ø§Ù„Ø­Ø¬Ø² Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹.";
                return;
            }

            const nameInput = document.getElementById('readerName');
            let name = nameInput.value.trim();
            if (!name) name = `Ù‚Ø§Ø±Ø¦Ø© ${(state.queue ? state.queue.length : 0) + 1}`;

            if (!state.queue) state.queue = [];
            const newReader = {
                id: Date.now(), 
                name: name,
                verses: "...", surah: "", startV: 0, endV: 0
            };

            state.queue.push(newReader);
            state = recalculateQueueVerses(state);
            saveState(state);

            myId = newReader.id;
            
            document.getElementById('bookingScreen').classList.add('hidden');
            document.getElementById('statusScreen').classList.remove('hidden');
            document.getElementById('welcomeName').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ: ${name}`;
            
            updateUserUI(state);
        }

        // --- ğŸ”¥ Ø¯ÙˆØ§Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„ØµÙˆØª (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ğŸ”¥ ---
        
        async function fetchQuranData(surahNum, startV, endV) {
            const displayDiv = document.getElementById('quranTextDisplay');
            const loadingDiv = document.getElementById('quranLoading');
            const audioDiv = document.getElementById('audioControls');
            
            loadingDiv.style.display = 'block';
            displayDiv.innerHTML = '';
            audioDiv.classList.add('hidden');

            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ù…Ù† API (api.alquran.cloud)
                // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø²Ø§Ø­Ø© ÙˆØ§Ù„Ø¹Ø¯Ø¯
                const limit = endV - startV + 1;
                const offset = startV - 1; // API ÙŠØ¨Ø¯Ø£ Ù…Ù† 0
                
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNum}/ar.alafasy?offset=${offset}&limit=${limit}`);
                const data = await response.json();

                if(data.code === 200) {
                    const ayahs = data.data.ayahs;
                    let fullText = "";
                    
                    // ØªØ¬Ù‡ÙŠØ² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØª
                    audioPlaylist = [];
                    currentAudioIndex = 0;

                    ayahs.forEach(ayah => {
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ
                        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø³Ù…Ù„Ø© Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¢ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„ÙØ§ØªØ­Ø© (Ù„Ø£Ù†Ù‡Ø§ ØªØ£ØªÙŠ Ù…Ø¯Ù…Ø¬Ø© Ø£Ø­ÙŠØ§Ù†Ø§Ù‹)
                        let text = ayah.text;
                        if(surahNum !== 1 && startV === 1) {
                             text = text.replace("Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„Ù‘ÙÙ‡Ù Ù±Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù", "").trim();
                        }

                        fullText += `<span class="ayah-span" id="ayah-${ayah.numberInSurah}">${text} <span class="ayah-symbol">Û</span> </span>`;

                        // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª (everyayah.com - Ø§Ù„Ø­ØµØ±ÙŠ)
                        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ù„ÙŠØµØ¨Ø­ 3 Ø®Ø§Ù†Ø§Øª (001)
                        const sID = String(surahNum).padStart(3, '0');
                        const vID = String(ayah.numberInSurah).padStart(3, '0');
                        audioPlaylist.push(`https://everyayah.com/data/Husary_128kbps/${sID}${vID}.mp3`);
                    });

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø³Ù…Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³ÙˆØ±Ø© (ÙˆÙ„ÙŠØ³Øª Ø§Ù„ÙØ§ØªØ­Ø© Ø£Ùˆ Ø§Ù„ØªÙˆØ¨Ø©)
                    if(startV === 1 && surahNum !== 1 && surahNum !== 9) {
                        displayDiv.innerHTML += '<div class="basmala">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„Ù‘ÙÙ‡Ù Ù±Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù</div>';
                    }

                    displayDiv.innerHTML += fullText;
                    loadingDiv.style.display = 'none';
                    audioDiv.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØµÙˆØª
                }

            } catch (error) {
                loadingDiv.innerText = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª (ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)";
                console.error(error);
            }
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙˆØª ---
        function toggleAudio() {
            const player = document.getElementById('audioPlayer');
            const btn = document.getElementById('playBtn');

            if (isPlaying) {
                player.pause();
                isPlaying = false;
                btn.innerHTML = 'ğŸ”Š Ø§Ø³ØªÙ…Ø±Ø§Ø±';
                btn.classList.remove('playing');
            } else {
                if(audioPlaylist.length > 0) {
                    if(!player.src) player.src = audioPlaylist[currentAudioIndex];
                    player.play();
                    isPlaying = true;
                    btn.innerHTML = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
                    btn.classList.add('playing');
                }
            }
        }

        // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¢ÙŠØ©ØŒ Ø´ØºÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ©
        document.getElementById('audioPlayer').onended = function() {
            currentAudioIndex++;
            if (currentAudioIndex < audioPlaylist.length) {
                this.src = audioPlaylist[currentAudioIndex];
                this.play();
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
                document.getElementById('audioStatus').innerText = `Ø¢ÙŠØ© ${currentAudioIndex + 1} Ù…Ù† ${audioPlaylist.length}`;
            } else {
                // Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªÙ„Ø§ÙˆØ©
                isPlaying = false;
                document.getElementById('playBtn').innerHTML = 'ğŸ”Š Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹';
                document.getElementById('playBtn').classList.remove('playing');
                document.getElementById('audioStatus').innerText = "";
                currentAudioIndex = 0; // Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
            }
        };


        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        let lastVersesHash = ""; // Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªÙƒØ±Ø±

        function updateUserUI(state) {
            if (!myId) return; 

            const myReader = state.queue ? state.queue.find(r => r.id === myId) : null;
            const myIndex = state.queue ? state.queue.findIndex(r => r.id === myId) : -1;
            const currentIndex = state.currentReaderIndex;

            if (!myReader) {
                if (!document.getElementById('statusScreen').classList.contains('hidden')) {
                    alert("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø².");
                    location.reload();
                }
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            let surahNameText = surahNames[state.settings.surah] || "Ù…Ø®ØªØ§Ø±Ø©";
            document.getElementById('surahTitle').innerText = `Ø³ÙˆØ±Ø© ${surahNameText} - ${myReader.verses}`;

            // ğŸ”¥ Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø¢ÙŠØ§Øª ğŸ”¥
            const currentHash = `${state.settings.surah}-${myReader.startV}-${myReader.endV}`;
            if (currentHash !== lastVersesHash) {
                lastVersesHash = currentHash;
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨
                fetchQuranData(state.settings.surah, myReader.startV, myReader.endV);
            }

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø§Ù„Ø© (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ­Ø­)
            if (myIndex < currentIndex && myIndex !== -1) {
                alert("Ø§Ù†ØªÙ‡Ù‰ Ø¯ÙˆØ±ÙƒØŒ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ùƒ!");
                location.reload();
                return;
            }

            const roleBox = document.getElementById('roleBox');
            const statusText = document.getElementById('statusText');
            const subStatus = document.getElementById('subStatus');
            const diff = myIndex - currentIndex;

            roleBox.classList.remove('waiting', 'ready', 'active');

            if (diff === 0) {
                roleBox.classList.add('active');
                statusText.innerText = "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† ğŸ¤";
                subStatus.innerText = "ØªÙØ¶Ù„ÙŠ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©";
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            } else if (diff === 1) {
                roleBox.classList.add('ready');
                if (currentIndex === -1) {
                    statusText.innerText = "Ø£Ù†ØªÙ Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰";
                    subStatus.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø±ÙØ© Ù„Ù„Ø¬Ù„Ø³Ø©...";
                } else {
                    statusText.innerText = "Ø§Ø³ØªØ¹Ø¯ÙŠ..";
                    subStatus.innerText = "Ø£Ù†ØªÙ Ø§Ù„Ù‚Ø§Ø±Ø¦Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
                }
            } else {
                roleBox.classList.add('waiting');
                statusText.innerText = "Ø§Ù†ØªØ¸Ø§Ø±";
                subStatus.innerText = `ÙŠØ³Ø¨Ù‚Ùƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ${diff - 1} Ù‚Ø§Ø±Ø¦Ø§Øª`;
            }
        }

        window.onload = function() {
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    updateUserUI(JSON.parse(e.newValue));
                }
            });
        };
    </script>
</body>
</html>
